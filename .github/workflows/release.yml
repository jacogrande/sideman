name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Swift version
        run: swift --version

      - name: Run tests
        run: swift test --package-path .

      - name: Import signing certificate
        if: ${{ env.DEVELOPER_CERTIFICATE_BASE64 != '' }}
        env:
          DEVELOPER_CERTIFICATE_BASE64: ${{ secrets.DEVELOPER_CERTIFICATE_BASE64 }}
          DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"
          CERT_PATH="$RUNNER_TEMP/certificate.p12"

          echo "$DEVELOPER_CERTIFICATE_BASE64" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import "$CERT_PATH" \
            -P "$DEVELOPER_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain-db

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Build release
        env:
          DEVELOPER_ID_APPLICATION: ${{ secrets.DEVELOPER_ID_APPLICATION }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          scripts/build-release.sh "$VERSION"

      - name: Verify artifacts
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          test -d "build/Sideman.app"
          test -f "build/Sideman-v${VERSION}.dmg"
          # Verify version is embedded in Info.plist
          EMBEDDED=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" build/Sideman.app/Contents/Info.plist)
          echo "Embedded version: $EMBEDDED"
          [[ "$EMBEDDED" == "$VERSION" ]]

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Sideman-DMG
          path: build/Sideman-v*.dmg

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          DMG_PATH="build/Sideman-v${VERSION}.dmg"

          PRERELEASE_FLAG=""
          if [[ "$VERSION" == *-* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          gh release create "$GITHUB_REF_NAME" "$DMG_PATH" \
            --title "Sideman $GITHUB_REF_NAME" \
            --generate-notes \
            $PRERELEASE_FLAG

      - name: Cleanup keychain
        if: always()
        run: |
          if [[ -n "${KEYCHAIN_PATH:-}" ]]; then
            security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          fi
